#!/usr/bin/env python

import os
import urwid
import subprocess
import sys
import getpass
import json
import base64
import assword

############################################################

def usage():
    prog = os.path.basename(sys.argv[0])
    print "Usage:", prog, "<command> [<args>...]"
    print """
commands:

  search <string>   Search the database for string.
  add [<context>]   Add a new entry.  If context is '-' read from stdin.
  dump              Plaintext dump of password database (as formatted json).
  help              This help.

environment:

  PGPID             OpenPGP key id of database encryption recipient.  Must be set.
  ASSWORD_DB        Path to assword database file (~/.assword.gpg by default).
  ASSWORD_PASSWORD  Length in bytes (18 by default), or prompt if 'prompt'.

"""

############################################################

class ListItem(urwid.WidgetWrap):
    def __init__(self, index, entry):
        self.index = index
        self.entry = entry

        w = urwid.AttrMap(
            urwid.Text('%s: %s' % (self.index, self.entry['context'])),
            'body', 'focus')
        self.__super.__init__(w)

    def selectable(self):
        return True

    def keypress(self, size, key):
        return key

def select(mset):

    palette = [
        ('body','dark cyan', '', 'standout'),
        ('focus','dark red', 'dark cyan', 'standout'),
        ('head','light red', 'black'),
        ]

    def keypress (input):
        global selected
        if input in ('q', 'Q'):
            raise urwid.ExitMainLoop()
        if input in ('n'):
            focus, pos = listbox.get_focus()
            if not focus: return
            listbox.set_focus(pos + 1)
        if input in ('p'):
            focus, pos = listbox.get_focus()
            if not focus: return
            if pos == 0: return
            listbox.set_focus(pos - 1)
        if input is 'enter':
            focus = listbox.get_focus()[0]
            selected = focus.entry
            raise urwid.ExitMainLoop()

    global selected
    selected = None

    items = []
    for index, entry in sorted(mset.iteritems()):
        items.append(ListItem(index, entry))

    listbox = urwid.ListBox(urwid.SimpleListWalker(items))
    view = urwid.Frame(urwid.AttrWrap(listbox, 'body'))
    loop = urwid.MainLoop(
        view,
        palette,
        unhandled_input=keypress,
        handle_mouse=False,
        )
    loop.run()

    return selected

############################################################

def pwgen():
    # number of characters to read
    n = int(os.getenv('ASSWORD_PASSWORD', 18))
    s = os.urandom(n)
    return base64.b64encode(s)

def xclip(text):
    p = subprocess.Popen(' '.join(["xclip", "-i", "-selection", "primary"]),
                         shell=True,
                         stdin=subprocess.PIPE)
    p.communicate(text)

############################################################

def check_key():
    if not KEY:
        print >>sys.stderr, "Error: OpenPGP key id not specified in PGPID env var."
        sys.exit(2)

def password_prompt():
    try:
        password0 = getpass.getpass('password: ')
        password1 = getpass.getpass('reenter password: ')
        if password0 != password1:
            print >>sys.stderr, "Error: Passwords do not match.  Aborting."
            sys.exit(3)
        return password0
    except KeyboardInterrupt:
        sys.exit(-1)

def add(args):
    # get context
    try:
        # as argument
        context = args[0]
        # or stdin
        if context == '-':
            context = sys.stdin.read()
    # or prompt
    except IndexError:
        context = raw_input('context: ')
    except KeyboardInterrupt:
        sys.exit(-1)
    # get password
    # from prompt if specified
    if os.getenv('ASSWORD_PASSWORD') == 'prompt':
        password = password_prompt()
    # otherwise auto generate
    else:
        print >>sys.stderr, "Auto-generating password... ",
        password = pwgen()
        print >>sys.stderr, "done."
    print password
    db = assword.Database(DB, KEY)
    newindex = db.add(context, password)
    db.save()
    print >>sys.stderr, "Wrote new entry:", newindex

def search(query):
    if not query:
        try:
            query = raw_input('search: ')
        except KeyboardInterrupt:
            sys.exit(-1)
    db = assword.Database(DB, KEY)
    results = db.search(query)
    if not results:
        print >>sys.stderr, "No results found."
        sys.exit(2)
    elif len(results) == 1:
        result = results.values()[0]
    else:
        try:
            result = select(results)
        except KeyboardInterrupt:
            sys.exit(-1)
    if not result:
        sys.exit(-1)
    xclip(result['password'])
    print >>sys.stderr, "Context:", result['context']
    print >>sys.stderr, "Password copied to clipboard."
    sys.exit()

############################################################

DB =  os.getenv('ASSWORD_DB', os.path.join(os.path.expanduser('~'),'.assword.gpg'))
KEY = os.getenv('PGPID')

if len(sys.argv) < 2:
    usage()
    sys.exit(1)

cmd = sys.argv[1]

if cmd == 'search':
    check_key()
    search(' '.join(sys.argv[2:]))
elif cmd == 'add':
    check_key()
    add(sys.argv[2:])
elif cmd == 'dump':
    check_key()
    db = assword.Database(DB, KEY)
    print json.dumps(db.entries, sort_keys=True, indent=2)
elif cmd == 'help':
    usage()
else:
    print >>sys.stderr, "Unknown command:", cmd
    print >>sys.stderr
    usage()
