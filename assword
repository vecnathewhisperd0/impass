#!/usr/bin/env python

import os
import urwid
import subprocess
import sys
import getpass
import json
import base64
import assword

############################################################

def usage():
    prog = os.path.basename(sys.argv[0])
    print "Usage:", prog, "<command> [<args>...]"
    print """
Commands:

  add [<context>]    Add a new entry.  If context is '-' read from stdin.
                     If not specified, user will be prompted for context.
                     See ASSWORD_PASSWORD for information on password.

  search [<string>]  Search the database for string.  If string not specified
                     user will be prompted.

  dump [<string>]    Dump search results as json.  If string not specified
                     all entries are returned.

  help               This help.

The search string "id:<id>" can be used to retrieve a single entry by
it's index.

Environment:

  PGPID             OpenPGP key id of database encryption recipient.
                    This variable is required to be set.

  ASSWORD_DB        Path to assword database file (default: ~/.assword.gpg).

  ASSWORD_PASSWORD  Length of auto-generated password in bytes (default: 18).
                    If set to 'prompt' user will be prompted for password.
"""

############################################################


############################################################

def pwgen(bytes):
    s = os.urandom(bytes)
    return base64.b64encode(s)

############################################################

def check_key():
    if not KEY:
        print >>sys.stderr, "Error: OpenPGP key id not specified in PGPID environment variable."
        sys.exit(2)

def password_prompt():
    try:
        password0 = getpass.getpass('password: ')
        password1 = getpass.getpass('reenter password: ')
        if password0 != password1:
            print >>sys.stderr, "Error: Passwords do not match.  Aborting."
            sys.exit(3)
        return password0
    except KeyboardInterrupt:
        sys.exit(-1)

def add(args):
    # get context
    try:
        # as argument
        context = args[0]
        # or stdin
        if context == '-':
            context = sys.stdin.read()
    # or prompt if nothing specified
    except IndexError:
        context = raw_input('context: ')
    except KeyboardInterrupt:
        sys.exit(-1)
    # get password from prompt if specified
    if os.getenv('ASSWORD_PASSWORD') == 'prompt':
        password = password_prompt()
    # otherwise auto generate
    else:
        print >>sys.stderr, "Auto-generating password...",
        bytes = int(os.getenv('ASSWORD_PASSWORD', 18))
        password = pwgen(bytes)
        print >>sys.stderr, "done."
    db = assword.Database(DB, KEY)
    newindex = db.add(context, password)
    db.save()
    print >>sys.stderr, "Wrote new entry:", newindex

def dump(query):
    db = assword.Database(DB, KEY)
    results = db.search(query)
    print json.dumps(results, sort_keys=True, indent=2)

############################################################

DB =  os.getenv('ASSWORD_DB', os.path.join(os.path.expanduser('~'),'.assword.gpg'))
KEY = os.getenv('PGPID')

if len(sys.argv) < 2:
    usage()
    sys.exit(1)

cmd = sys.argv[1]

if cmd == 'add':
    check_key()
    add(sys.argv[2:])
elif cmd == 'dump':
    check_key()
    dump(' '.join(sys.argv[2:]))
elif cmd == 'help':
    usage()
else:
    print >>sys.stderr, "Unknown command:", cmd
    print >>sys.stderr
    usage()
